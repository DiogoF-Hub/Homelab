# Real domain is replaced by test.domain.com
test.domain.com {
    tls /ssl/fullchain.pem /ssl/privkey.pem {
        protocols tls1.3
        curves x25519 secp256r1
    }

    encode zstd gzip
    root * /srv

    # Global headers only include what Vaultwarden doesn't set (to avoid conflicts), while TXT-specific headers add stricter policies for static files.
    # -------- Global headers (apply to everything) --------
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "same-origin"
        Permissions-Policy "accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), interest-cohort=(), magnetometer=(), microphone=(), midi=(), payment=(), picture-in-picture=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=()"
        Cross-Origin-Opener-Policy "same-origin"
        -Server
        -Via
    }

    # -------- robots.txt (TXT-only headers) --------
    handle /robots.txt {
        header {
            Content-Security-Policy "default-src 'none'; base-uri 'none'; frame-ancestors 'none'"
            X-Frame-Options "SAMEORIGIN"
            Cross-Origin-Resource-Policy "same-origin"
            X-Robots-Tag "noindex, nofollow"
            X-XSS-Protection "0"
        }
        file_server
    }

    # -------- /.well-known/security.txt (TXT-only headers) --------
    handle /.well-known/security.txt {
        header {
            Content-Security-Policy "default-src 'none'; base-uri 'none'; frame-ancestors 'none'"
            X-Frame-Options "SAMEORIGIN"
            Cross-Origin-Resource-Policy "same-origin"
            X-Robots-Tag "noindex, nofollow"
            X-XSS-Protection "0"
        }
        file_server
    }

    # -------- /security.txt -> internal rewrite to canonical file (TXT-only headers) --------
    handle /security.txt {
        header {
            Content-Security-Policy "default-src 'none'; base-uri 'none'; frame-ancestors 'none'"
            X-Frame-Options "SAMEORIGIN"
            Cross-Origin-Resource-Policy "same-origin"
            X-Robots-Tag "noindex, nofollow"
            X-XSS-Protection "0"
        }
        rewrite * /.well-known/security.txt
        file_server
    }

    # -------- Catch-all: reverse proxy to Vaultwarden --------
    reverse_proxy vaultwarden:80 {
        header_up Host {host}
        header_up X-Real-IP {>CF-Connecting-IP}
        header_up X-Forwarded-For {>CF-Connecting-IP}
        header_up X-Forwarded-Proto {scheme}
    }
}
